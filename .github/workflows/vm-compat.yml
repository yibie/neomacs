name: vm-compat

on:
  pull_request:
    paths:
      - "rust/**"
      - "test/neovm/vm-compat/**"
      - ".github/workflows/vm-compat.yml"
  push:
    branches:
      - main
    paths:
      - "rust/**"
      - "test/neovm/vm-compat/**"
      - ".github/workflows/vm-compat.yml"

jobs:
  neovm-backend-feature-matrix:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        backend:
          - core-backend-emacs-c
          - core-backend-rust
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            rust/neovm-core
            rust/neovm-worker

      - name: Check neovm-core for backend feature
        run: |
          RUSTFLAGS='-Awarnings' cargo check \
            --manifest-path rust/neovm-core/Cargo.toml \
            --no-default-features \
            --features ${{ matrix.backend }}

      - name: Check neovm-worker for backend feature
        run: |
          RUSTFLAGS='-Awarnings' cargo check \
            --manifest-path rust/neovm-worker/Cargo.toml \
            --no-default-features \
            --features ${{ matrix.backend }}

  neovm-vm-compat-thread:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            rust/neovm-core
            rust/neovm-worker

      - name: Run NeoVM thread compatibility suite
        working-directory: test/neovm/vm-compat
        run: |
          RUSTFLAGS='-Awarnings' make check-thread-neovm

  neovm-vm-compat-introspection:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            rust/neovm-core
            rust/neovm-worker

      - name: Run NeoVM introspection compatibility suite
        working-directory: test/neovm/vm-compat
        run: |
          RUSTFLAGS='-Awarnings' make check-introspection-neovm

  vm-compat-ert-allowlist:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Emacs for oracle checks
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y emacs-nox

      - name: Run ERT allowlist oracle check
        working-directory: test/neovm/vm-compat
        env:
          NEOVM_FORCE_ORACLE_PATH: /usr/bin/emacs
        run: |
          make check-ert-allowlist

  neovm-vm-compat:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Emacs for oracle checks
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y emacs-nox

      - name: Verify oracle baselines
        working-directory: test/neovm/vm-compat
        env:
          NEOVM_FORCE_ORACLE_PATH: /usr/bin/emacs
        run: |
          make check-all

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            rust/neovm-core
            rust/neovm-worker

      - name: Run NeoVM compatibility corpus
        working-directory: test/neovm/vm-compat
        run: |
          RUSTFLAGS='-Awarnings' make check-all-neovm

      - name: Check builtin registry fboundp parity
        working-directory: test/neovm/vm-compat
        env:
          NEOVM_FORCE_ORACLE_PATH: /usr/bin/emacs
        run: |
          make check-builtin-registry-fboundp

  neovm-vm-compat-legacy-elc:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            rust/neovm-core
            rust/neovm-worker

      - name: Run NeoVM legacy .elc literal compatibility corpus
        working-directory: test/neovm/vm-compat
        env:
          NEOVM_WORKER_CARGO_FEATURES: legacy-elc-literal
        run: |
          RUSTFLAGS='-Awarnings' make check-legacy-elc-neovm
