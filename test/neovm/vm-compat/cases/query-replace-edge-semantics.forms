(with-temp-buffer
  (insert "cat scatter cat")
  (goto-char (point-min))
  (let ((unread-command-events (list ?!)))
    (query-replace "cat" "dog" t))
  (buffer-string))

(with-temp-buffer
  (insert "cat scatter cat")
  (goto-char (point-min))
  (let ((unread-command-events (list ?!)))
    (query-replace-regexp "cat" "dog" t))
  (buffer-string))

(with-temp-buffer
  (insert "Foo foo")
  (let ((case-fold-search nil)
        (unread-command-events (list ?!)))
    (query-replace "foo" "bar"))
  (buffer-string))

(with-temp-buffer
  (insert "a1 b22 c333")
  (goto-char (point-min))
  (let ((unread-command-events (list ?!)))
    (query-replace-regexp "\\([0-9]+\\)" "[\\1]"))
  (buffer-string))

(with-temp-buffer
  (insert "foo foo foo")
  (goto-char (point-max))
  (let ((unread-command-events (list ?!)))
    (query-replace "foo" "bar" nil nil nil t))
  (list (buffer-string) (point)))

(with-temp-buffer
  (insert "foo foo foo")
  (goto-char (point-max))
  (let ((unread-command-events (list ?!)))
    (query-replace-regexp "foo" "bar" nil nil nil t))
  (list (buffer-string) (point)))

(with-temp-buffer
  (insert "abc")
  (goto-char (point-min))
  (let ((unread-command-events (list ?!)))
    (query-replace-regexp "" "x"))
  (list (buffer-string) (point)))

(with-temp-buffer
  (insert "abc")
  (goto-char (point-min))
  (let ((unread-command-events (list ?!)))
    (query-replace "" "x" nil 2 3))
  (list (buffer-string) (point)))

(with-temp-buffer
  (insert "cat scatter cat")
  (goto-char (point-min))
  (let ((unread-command-events (list ?!)))
    (query-replace-regexp "cat" "dog" nil 5 1))
  (list (buffer-string) (point)))

(condition-case err
    (with-temp-buffer
      (insert "x")
      (let ((unread-command-events (list ?!)))
        (query-replace-regexp "[a-" "b")))
  (invalid-regexp (car err)))

(with-temp-buffer
  (insert "foo foo")
  (goto-char 5)
  (set-mark 1)
  (let ((unread-command-events (list ?!)))
    (query-replace "foo" "bar" nil nil nil nil t))
  (list (buffer-string) (point)))

(with-temp-buffer
  (insert "foo foo")
  (goto-char 5)
  (set-mark 1)
  (let ((unread-command-events (list ?!)))
    (query-replace-regexp "foo" "bar" nil nil nil t t))
  (list (buffer-string) (point)))
