; set-mark-command and activate-mark behavior around mark-active publication.
(fboundp 'activate-mark)
(symbol-function 'activate-mark)

(with-temp-buffer
  (setq mark-active nil)
  (list (activate-mark) mark-active))

(with-temp-buffer
  (set-mark (point-min))
  (setq mark-active nil)
  (list (activate-mark) mark-active (mark t)))

(with-temp-buffer
  (insert "abc")
  (goto-char (point-max))
  (let ((transient-mark-mode t))
    (set-mark-command nil)
    (list (mark t) (point) mark-active (use-region-p))))

(with-temp-buffer
  (condition-case err
      (set-mark-command)
    (error (car err))))

(with-temp-buffer
  (condition-case err
      (set-mark-command nil nil)
    (error (car err))))

(with-temp-buffer
  (insert "abc")
  (goto-char (point-max))
  (condition-case err
      (set-mark-command '(4))
    (error (car err))))

(with-temp-buffer
  (insert "abc")
  (goto-char (point-max))
  (set-mark (point-min))
  (setq mark-active nil)
  (set-mark-command '(4))
  (list (point) (mark t) mark-active))

(with-temp-buffer
  (insert "abc")
  (goto-char (point-max))
  (set-mark (point-min))
  (setq mark-active t)
  (set-mark-command '(4))
  (list (point) (mark t) mark-active))
